name: Deploy Portfolio

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Verify required files
      run: |
        echo "Verifying required files..."
        test -f docker-compose.yml || exit 1
        test -f Dockerfile || exit 1
        test -f .env.example || exit 1
        echo "âœ… File verification passed"

    - name: ğŸ”¨ Build and test
      run: |
        echo "ğŸš€ Building application..."
        cp .env.example .env
        docker-compose build --no-cache
        echo "âœ… Build successful"

    - name: ğŸ§ª Run health checks
      run: |
        echo "ğŸ¥ Starting health checks..."
        docker-compose up -d
        sleep 30
        
        # Check if services are running
        if curl -f -s http://localhost:80 > /dev/null; then
          echo "âœ… Application health check passed"
        else
          echo "âŒ Application health check failed"
          docker-compose logs
          exit 1
        fi

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        docker-compose down --volumes --remove-orphans
        docker system prune -f

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to production
      run: |
        echo "ğŸš€ Starting production deployment..."
        echo "This is where you'd deploy to your server"
        echo "For now, just building and verifying..."
        
        cp .env.example .env
        docker-compose up -d --build
        sleep 20
        
        if curl -f -s http://localhost:80 > /dev/null; then
          echo "âœ… Deployment verification successful!"
          echo "ğŸŒ Application would be available at your domain"
        else
          echo "âŒ Deployment verification failed"
          docker-compose logs
          exit 1
        fi

    - name: ğŸ“Š Deployment summary
      run: |
        echo "ğŸ“Š Deployment Summary:"
        echo "âœ… Build: Successful"
        echo "âœ… Health Check: Passed" 
        echo "âœ… Deployment: Complete"
        echo "ğŸŒ Status: Ready for production"